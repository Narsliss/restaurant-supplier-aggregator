#!/bin/bash
set -e

# Determine which process to start based on PROCESS_TYPE
case "${PROCESS_TYPE:-web}" in
  web)
    echo "Starting web server..."
    ./bin/rails server -b 0.0.0.0 -p ${PORT:-8080} &
    WEB_PID=$!

    # Wait for Puma to bind to the port before starting Solid Queue.
    # This ensures Railway's healthcheck passes quickly.
    echo "Waiting for web server to be ready..."
    for i in $(seq 1 60); do
      if curl -sf http://localhost:${PORT:-8080}/up > /dev/null 2>&1; then
        echo "Web server ready."
        break
      fi
      sleep 1
    done

    echo "Starting Solid Queue worker in background..."
    bundle exec rake solid_queue:start &
    SOLID_QUEUE_PID=$!
    echo "Solid Queue started (PID: $SOLID_QUEUE_PID)"

    # Shut down both processes on exit signals
    cleanup() {
      echo "Shutting down..."
      kill $SOLID_QUEUE_PID 2>/dev/null
      kill $WEB_PID 2>/dev/null
      wait $SOLID_QUEUE_PID 2>/dev/null
      wait $WEB_PID 2>/dev/null
    }
    trap cleanup EXIT INT TERM

    # Wait for the web server process â€” if it exits, the script exits
    wait $WEB_PID
    ;;
  worker)
    echo "Starting Solid Queue worker..."
    exec bundle exec rake solid_queue:start
    ;;
  *)
    echo "Unknown PROCESS_TYPE: $PROCESS_TYPE"
    echo "Valid options: web, worker"
    exit 1
    ;;
esac
