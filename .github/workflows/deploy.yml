name: Deploy to Railway

on:
  push:
    branches: [ main ]

jobs:
  deploy-web:
    name: Deploy Web Service
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Railway CLI
      run: npm install -g @railway/cli

    - name: Deploy Web Service
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        railway up --service web --detach

    - name: Run database migrations
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        railway run --service web bundle exec rails db:migrate || true

    - name: Seed database (if needed)
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        railway run --service web bundle exec rails db:seed || true

  deploy-worker:
    name: Deploy Worker Service
    runs-on: ubuntu-latest
    needs: deploy-web
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Railway CLI
      run: npm install -g @railway/cli

    - name: Deploy Worker Service
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        railway up --service worker --detach

  notify:
    name: Notify on Status
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-worker]
    if: always()
    
    steps:
    - name: Notify success
      if: needs.deploy-web.result == 'success' && needs.deploy-worker.result == 'success'
      run: |
        echo "✅ Deployment to Railway completed successfully!"
        echo "Web service and worker service have been updated."

    - name: Notify failure
      if: needs.deploy-web.result == 'failure' || needs.deploy-worker.result == 'failure'
      run: |
        echo "❌ Deployment to Railway failed!"
        echo "Please check the logs for more details."
        exit 1
