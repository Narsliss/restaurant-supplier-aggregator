version: "3.8"

services:
  # Rails Web Application
  web:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${PORT:-3000}:3000"
    environment:
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      RAILS_SERVE_STATIC_FILES: "true"
      DATABASE_PATH: /rails/db/production.sqlite3
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      GROQ_API_KEY: ${GROQ_API_KEY}
      # Browser settings for Ferrum
      BROWSER_PATH: /usr/bin/chromium
      BROWSER_HEADLESS: "true"
      # Encryption key for credentials (generate with: rails secret)
      ATTR_ENCRYPTED_KEY: ${ATTR_ENCRYPTED_KEY}
      # Disable SSL for local Docker testing
      DISABLE_SSL: ${DISABLE_SSL:-}
      # Stripe
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_MONTHLY_PRICE_ID: ${STRIPE_MONTHLY_PRICE_ID:-}
      STRIPE_TRIAL_DAYS: ${STRIPE_TRIAL_DAYS:-14}
    volumes:
      - sqlite_data:/rails/db
      - rails_storage:/rails/storage
      - rails_tmp:/rails/tmp
    restart: unless-stopped

  # Solid Queue Background Worker
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    command: bundle exec rake solid_queue:start
    environment:
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      DATABASE_PATH: /rails/db/production.sqlite3
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      GROQ_API_KEY: ${GROQ_API_KEY}
      # Browser settings for Ferrum (scraping runs here)
      BROWSER_PATH: /usr/bin/chromium
      BROWSER_HEADLESS: "true"
      ATTR_ENCRYPTED_KEY: ${ATTR_ENCRYPTED_KEY}
    volumes:
      - sqlite_data:/rails/db
      - rails_storage:/rails/storage
      - rails_tmp:/rails/tmp
    restart: unless-stopped

volumes:
  sqlite_data:
  rails_storage:
  rails_tmp:
