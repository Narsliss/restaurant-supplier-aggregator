<div class="max-w-5xl mx-auto pb-24" data-controller="order-review" data-order-review-batch-id-value="<%= @batch_id %>">
  <div class="mb-6">
    <% if @aggregated_list_id.present? %>
      <%= link_to "&larr; Back to Order Builder".html_safe, order_builder_aggregated_list_path(@aggregated_list_id, batch_id: @batch_id), class: "text-sm text-brand-orange hover:text-brand-orange-light" %>
    <% else %>
      <%= link_to "&larr; Order History".html_safe, orders_path, class: "text-sm text-brand-orange hover:text-brand-orange-light" %>
    <% end %>
  </div>

  <div class="flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-start mb-6">
    <div>
      <h1 class="text-2xl font-heading font-bold text-gray-900">Review Orders</h1>
      <p class="mt-1 text-sm text-gray-500">
        Review your orders below, adjust quantities if needed, then submit when ready.
      </p>
    </div>
  </div>

  <%# Minimum warnings %>
  <% unmet = @review_orders.reject { |r| r[:meets_minimum] } %>
  <% if unmet.any? %>
    <div class="mb-6 space-y-2" data-order-review-target="warningsArea">
      <% unmet.each do |r| %>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4" data-order-review-target="minimumWarning" data-order-id="<%= r[:order].id %>">
          <p class="text-yellow-800 text-sm">
            <span class="font-medium">Warning:</span>
            <%= r[:supplier].name %> order minimum not met.
            <span class="text-yellow-600">
              Current: <%= number_to_currency(r[:subtotal]) %>,
              Need: <%= number_to_currency(r[:amount_to_minimum]) %> more
              (Minimum: <%= number_to_currency(r[:minimum]) %>)
            </span>
          </p>
        </div>
      <% end %>
    </div>
  <% end %>

  <%# Summary KPI bar %>
  <div class="bg-white shadow rounded-lg p-4 mb-6" data-order-review-target="summaryBar">
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
      <div>
        <p class="text-2xl font-bold text-gray-900" data-order-review-target="summaryOrders"><%= @summary[:order_count] %></p>
        <p class="text-xs text-gray-500">Orders</p>
      </div>
      <div>
        <p class="text-2xl font-bold text-gray-900" data-order-review-target="summaryItems"><%= @summary[:total_items] %></p>
        <p class="text-xs text-gray-500">Items</p>
      </div>
      <div>
        <p class="text-2xl font-bold text-green-600" data-order-review-target="summaryTotal"><%= number_to_currency(@summary[:total_amount]) %></p>
        <p class="text-xs text-gray-500">Total</p>
      </div>
      <div>
        <p class="text-2xl font-bold text-brand-green" data-order-review-target="summarySavings"><%= number_to_currency(@summary[:total_savings]) %></p>
        <p class="text-xs text-gray-500">Estimated Savings</p>
      </div>
    </div>
  </div>

  <%# Per-supplier order cards %>
  <div class="space-y-6 mb-6">
    <% @review_orders.each do |review| %>
      <% order = review[:order] %>
      <% supplier = review[:supplier] %>
      <% minimum = review[:minimum] %>

      <div class="bg-white shadow rounded-lg overflow-hidden <%= review[:meets_minimum] ? '' : 'ring-2 ring-yellow-400' %>"
           data-order-review-target="orderCard"
           data-order-id="<%= order.id %>"
           data-supplier-name="<%= supplier.name %>"
           data-minimum="<%= minimum || 0 %>">

        <%# Supplier header %>
        <div class="px-4 py-3 bg-gray-50 border-b flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
          <div>
            <h3 class="font-medium text-gray-900"><%= supplier.name %></h3>
            <p class="text-sm text-gray-500">
              <span data-order-review-target="orderItemCount" data-order-id="<%= order.id %>"><%= review[:item_count] %></span> items &middot;
              <span data-order-review-target="orderSubtotal" data-order-id="<%= order.id %>"><%= number_to_currency(review[:subtotal]) %></span>
              <% unless review[:meets_minimum] %>
                <span class="text-yellow-600 ml-2" data-order-review-target="minimumShortfall" data-order-id="<%= order.id %>">
                  (Need <%= number_to_currency(review[:amount_to_minimum]) %> more for minimum)
                </span>
              <% end %>
            </p>
          </div>
          <div class="flex items-center gap-3">
            <% if review[:meets_minimum] %>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" data-order-review-target="minimumBadge" data-order-id="<%= order.id %>">
                Ready
              </span>
            <% else %>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800" data-order-review-target="minimumBadge" data-order-id="<%= order.id %>">
                Minimum not met
              </span>
            <% end %>
            <%= button_to "Submit Order",
                submit_batch_orders_path(batch_id: @batch_id, order_ids: [order.id]),
                method: :post,
                class: "px-4 py-1.5 rounded-md text-sm font-semibold text-white shadow-sm transition-colors #{review[:meets_minimum] ? 'bg-brand-orange hover:bg-brand-orange-dark cursor-pointer' : 'bg-gray-300 cursor-not-allowed'}",
                disabled: !review[:meets_minimum],
                data: { order_review_target: "supplierSubmitBtn", order_id: order.id.to_s } %>
          </div>
        </div>

        <%# Delivery date & notes %>
        <div class="px-4 py-3 bg-gray-50 border-b flex flex-col sm:flex-row gap-3">
          <div class="flex-1">
            <label class="block text-xs font-medium text-gray-500 mb-1">Delivery Date</label>
            <input type="date"
                   value="<%= order.delivery_date %>"
                   min="<%= Date.tomorrow %>"
                   max="<%= Date.today + 30.days %>"
                   class="w-full sm:w-48 rounded-md border-gray-300 shadow-sm focus:border-brand-green focus:ring-brand-green text-sm"
                   data-action="change->order-review#updateDeliveryDate"
                   data-order-review-target="deliveryDate"
                   data-order-id="<%= order.id %>">
          </div>
          <div class="flex-1">
            <label class="block text-xs font-medium text-gray-500 mb-1">Notes</label>
            <input type="text"
                   value="<%= order.notes %>"
                   placeholder="Order notes..."
                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-brand-green focus:ring-brand-green text-sm"
                   data-action="change->order-review#updateNotes"
                   data-order-id="<%= order.id %>">
          </div>
        </div>

        <%# Desktop items table %>
        <div class="hidden sm:block">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">SKU</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Qty</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Unit Price</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase w-10"></th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% review[:items].each do |item| %>
                <tr data-order-review-target="itemRow"
                    data-item-id="<%= item.id %>"
                    data-order-id="<%= order.id %>"
                    data-unit-price="<%= item.unit_price %>">
                  <td class="px-4 py-2 text-sm text-gray-900"><%= item.supplier_product.supplier_name %></td>
                  <td class="px-4 py-2 text-sm text-gray-500"><%= item.supplier_sku %></td>
                  <td class="px-4 py-2 text-center">
                    <div class="inline-flex items-center gap-1">
                      <button type="button"
                              data-action="order-review#decrementItem"
                              data-item-id="<%= item.id %>"
                              data-order-id="<%= order.id %>"
                              class="w-7 h-7 flex items-center justify-center rounded-md border border-gray-300 text-gray-600 hover:bg-gray-200 hover:border-gray-400 hover:text-gray-900 active:bg-gray-300 transition-colors text-sm">
                        &minus;
                      </button>
                      <input type="number"
                             value="<%= item.quantity %>"
                             min="1"
                             class="w-14 rounded-md border-gray-300 text-sm text-center [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                             data-order-review-target="quantityInput"
                             data-action="change->order-review#updateQuantity"
                             data-item-id="<%= item.id %>"
                             data-order-id="<%= order.id %>">
                      <button type="button"
                              data-action="order-review#incrementItem"
                              data-item-id="<%= item.id %>"
                              data-order-id="<%= order.id %>"
                              class="w-7 h-7 flex items-center justify-center rounded-md border border-gray-300 text-gray-600 hover:bg-gray-200 hover:border-gray-400 hover:text-gray-900 active:bg-gray-300 transition-colors text-sm">
                        +
                      </button>
                    </div>
                  </td>
                  <td class="px-4 py-2 text-sm text-gray-900 text-right"><%= number_to_currency(item.unit_price) %></td>
                  <td class="px-4 py-2 text-sm font-medium text-gray-900 text-right" data-order-review-target="lineTotal" data-item-id="<%= item.id %>">
                    <%= number_to_currency(item.line_total) %>
                  </td>
                  <td class="px-4 py-2 text-center">
                    <button type="button"
                            data-action="order-review#removeItem"
                            data-item-id="<%= item.id %>"
                            data-order-id="<%= order.id %>"
                            class="text-red-400 hover:text-red-600 transition-colors"
                            title="Remove item">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                      </svg>
                    </button>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <%# Mobile cards %>
        <div class="sm:hidden divide-y divide-gray-200">
          <% review[:items].each do |item| %>
            <div class="p-3"
                 data-order-review-target="itemRow"
                 data-item-id="<%= item.id %>"
                 data-order-id="<%= order.id %>"
                 data-unit-price="<%= item.unit_price %>">
              <div class="flex justify-between items-start mb-2">
                <div class="flex-1 min-w-0 mr-3">
                  <p class="text-sm font-medium text-gray-900"><%= item.supplier_product.supplier_name %></p>
                  <p class="text-xs text-gray-400">SKU: <%= item.supplier_sku %></p>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-sm font-semibold text-gray-900" data-order-review-target="lineTotal" data-item-id="<%= item.id %>">
                    <%= number_to_currency(item.line_total) %>
                  </span>
                  <button type="button"
                          data-action="order-review#removeItem"
                          data-item-id="<%= item.id %>"
                          data-order-id="<%= order.id %>"
                          class="text-red-400 hover:text-red-600 transition-colors"
                          title="Remove item">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs text-gray-500"><%= number_to_currency(item.unit_price) %> each</span>
                <div class="inline-flex items-center gap-1">
                  <button type="button"
                          data-action="order-review#decrementItem"
                          data-item-id="<%= item.id %>"
                          data-order-id="<%= order.id %>"
                          class="w-8 h-8 flex items-center justify-center rounded-md border border-gray-300 text-gray-600 hover:bg-gray-200 hover:border-gray-400 hover:text-gray-900 active:bg-gray-300 transition-colors">
                    &minus;
                  </button>
                  <input type="number"
                         value="<%= item.quantity %>"
                         min="1"
                         class="w-14 rounded-md border-gray-300 text-sm text-center [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                         data-order-review-target="quantityInput"
                         data-action="change->order-review#updateQuantity"
                         data-item-id="<%= item.id %>"
                         data-order-id="<%= order.id %>">
                  <button type="button"
                          data-action="order-review#incrementItem"
                          data-item-id="<%= item.id %>"
                          data-order-id="<%= order.id %>"
                          class="w-8 h-8 flex items-center justify-center rounded-md border border-gray-300 text-gray-600 hover:bg-gray-200 hover:border-gray-400 hover:text-gray-900 active:bg-gray-300 transition-colors">
                    +
                  </button>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <%# Order footer with subtotal %>
        <div class="px-4 py-3 bg-gray-50 border-t flex justify-between items-center">
          <span class="text-sm font-medium text-gray-700">
            Subtotal: <span data-order-review-target="orderSubtotalFooter" data-order-id="<%= order.id %>"><%= number_to_currency(review[:subtotal]) %></span>
          </span>
        </div>
      </div>
    <% end %>
  </div>

  <%# Bottom action bar %>
  <div class="bg-white shadow rounded-lg p-4 sm:p-6">
    <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
      <%= link_to "Back to Order Lists", supplier_lists_path,
          class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-center" %>

      <% if @summary[:all_minimums_met] %>
        <%= button_to "Submit All Orders",
            submit_batch_orders_path(batch_id: @batch_id),
            method: :post,
            class: "px-6 py-2 text-sm font-semibold text-white bg-brand-orange rounded-md hover:bg-brand-orange-dark cursor-pointer shadow-sm transition-colors text-center",
            data: { order_review_target: "submitAllBtn" } %>
      <% else %>
        <span class="px-6 py-2 text-sm font-semibold text-white bg-gray-300 rounded-md cursor-not-allowed text-center"
              data-order-review-target="submitAllBtn"
              title="Some suppliers don't meet order minimums">
          Submit All Orders
        </span>
      <% end %>
    </div>
  </div>
</div>
