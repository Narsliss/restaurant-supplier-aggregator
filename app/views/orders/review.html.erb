<div class="max-w-5xl mx-auto pb-24"
     data-controller="order-review"
     data-order-review-batch-id-value="<%= @batch_id %>"
     data-order-review-verifying-value="<%= @verifying %>"
     data-order-review-aggregated-list-id-value="<%= @aggregated_list_id %>">
  <div class="mb-6">
    <% if @aggregated_list_id.present? %>
      <%= link_to "&larr; Back to Order Builder".html_safe, order_builder_aggregated_list_path(@aggregated_list_id, batch_id: @batch_id), class: "text-sm text-brand-orange hover:text-brand-orange-light" %>
    <% else %>
      <%= link_to "&larr; Order History".html_safe, orders_path, class: "text-sm text-brand-orange hover:text-brand-orange-light" %>
    <% end %>
  </div>

  <div class="flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-start mb-6">
    <div>
      <h1 class="text-2xl font-heading font-bold text-gray-900">Review Orders</h1>
      <p class="mt-1 text-sm text-gray-500">
        Verifying live prices with suppliers. Review your orders below, then submit when ready.
      </p>
    </div>
  </div>

  <%# Verification progress banner (shown when verifying) %>
  <div class="mb-6 <%= @verifying ? '' : 'hidden' %>" data-order-review-target="verificationBanner">
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="flex items-center gap-3">
        <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <div>
          <p class="text-blue-800 font-medium text-sm">Verifying prices with suppliers...</p>
          <p class="text-blue-600 text-xs mt-0.5" data-order-review-target="verificationProgress">
            Checking live prices before submission
          </p>
        </div>
      </div>
    </div>
  </div>

  <%# Price changes banner (shown when price changes detected) %>
  <div class="mb-6 hidden" data-order-review-target="priceChangeBanner">
    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
      <div class="flex items-start gap-3">
        <svg class="h-5 w-5 text-amber-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
        </svg>
        <div class="flex-1">
          <p class="text-amber-800 font-medium text-sm">Some prices have changed since you built this order</p>
          <p class="text-amber-600 text-xs mt-0.5">Review the changes below. You can accept the new prices or cancel.</p>
        </div>
        <div class="flex gap-2 flex-shrink-0">
          <button type="button"
                  data-action="order-review#acceptAllPriceChanges"
                  class="px-3 py-1.5 text-xs font-semibold text-white bg-brand-orange rounded-md hover:bg-brand-orange-dark transition-colors">
            Accept All Changes
          </button>
          <button type="button"
                  data-action="order-review#skipAllVerification"
                  class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
            Skip Verification
          </button>
        </div>
      </div>
    </div>
  </div>

  <%# Verification failed banner %>
  <div class="mb-6 hidden" data-order-review-target="verificationFailedBanner">
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
      <div class="flex items-start gap-3">
        <svg class="h-5 w-5 text-red-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div class="flex-1">
          <p class="text-red-800 font-medium text-sm">Price verification failed for some orders</p>
          <p class="text-red-600 text-xs mt-0.5" data-order-review-target="verificationFailedMessage">
            Could not connect to supplier(s). You can retry or skip verification.
          </p>
        </div>
        <div class="flex gap-2 flex-shrink-0">
          <button type="button"
                  data-action="order-review#retryVerification"
                  class="px-3 py-1.5 text-xs font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">
            Retry
          </button>
          <button type="button"
                  data-action="order-review#skipAllVerification"
                  class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
            Skip & Submit
          </button>
        </div>
      </div>
    </div>
  </div>

  <%# Minimum warnings %>
  <% unmet = @review_orders.reject { |r| r[:meets_minimum] } %>
  <% if unmet.any? %>
    <div class="mb-6 space-y-2" data-order-review-target="warningsArea">
      <% unmet.each do |r| %>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4" data-order-review-target="minimumWarning" data-order-id="<%= r[:order].id %>">
          <p class="text-yellow-800 text-sm">
            <span class="font-medium">Warning:</span>
            <%= r[:supplier].name %> order minimum not met.
            <span class="text-yellow-600" data-order-review-target="minimumShortfall" data-order-id="<%= r[:order].id %>">
              Current: <%= number_to_currency(r[:subtotal]) %>,
              Need: <%= number_to_currency(r[:amount_to_minimum]) %> more
              (Minimum: <%= number_to_currency(r[:minimum]) %>)
            </span>
          </p>
        </div>
      <% end %>
    </div>
  <% end %>

  <%# Summary KPI bar %>
  <div class="bg-white shadow rounded-lg p-4 mb-6" data-order-review-target="summaryBar">
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
      <div>
        <p class="text-2xl font-bold text-gray-900" data-order-review-target="summaryOrders"><%= @summary[:order_count] %></p>
        <p class="text-xs text-gray-500">Orders</p>
      </div>
      <div>
        <p class="text-2xl font-bold text-gray-900" data-order-review-target="summaryItems"><%= @summary[:total_items] %></p>
        <p class="text-xs text-gray-500">Items</p>
      </div>
      <div>
        <p class="text-2xl font-bold text-green-600" data-order-review-target="summaryTotal"><%= number_to_currency(@summary[:total_amount]) %></p>
        <p class="text-xs text-gray-500">Total</p>
      </div>
      <div>
        <p class="text-2xl font-bold text-brand-green" data-order-review-target="summarySavings"><%= number_to_currency(@summary[:total_savings]) %></p>
        <p class="text-xs text-gray-500">Estimated Savings</p>
      </div>
    </div>
  </div>

  <%# Per-supplier order cards %>
  <div class="space-y-6 mb-6">
    <% @review_orders.each do |review| %>
      <% order = review[:order] %>
      <% supplier = review[:supplier] %>
      <% minimum = review[:minimum] %>

      <div class="bg-white shadow rounded-lg overflow-hidden <%= review[:meets_minimum] ? '' : 'ring-2 ring-yellow-400' %>"
           data-order-review-target="orderCard"
           data-order-id="<%= order.id %>"
           data-supplier-name="<%= supplier.name %>"
           data-minimum="<%= minimum || 0 %>"
           data-verification-status="<%= order.verification_status %>">

        <%# Supplier header %>
        <div class="px-4 py-3 bg-gray-50 border-b flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
          <div>
            <div class="flex items-center gap-2">
              <h3 class="font-medium text-gray-900"><%= supplier.name %></h3>
              <%# Verification status indicator per order %>
              <span class="<%= order.verifying? ? '' : 'hidden' %>" data-order-review-target="verifyingIndicator" data-order-id="<%= order.id %>">
                <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </span>
              <span class="hidden items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" data-order-review-target="verifiedBadge" data-order-id="<%= order.id %>">
                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                Verified
              </span>
              <span class="hidden items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800" data-order-review-target="priceChangedBadge" data-order-id="<%= order.id %>">
                Price Changed
              </span>
              <span class="hidden items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800" data-order-review-target="verifyFailedBadge" data-order-id="<%= order.id %>">
                Verification Failed
              </span>
            </div>
            <p class="text-sm text-gray-500">
              <span data-order-review-target="orderItemCount" data-order-id="<%= order.id %>"><%= review[:item_count] %></span> items &middot;
              <span data-order-review-target="orderSubtotal" data-order-id="<%= order.id %>"><%= number_to_currency(review[:subtotal]) %></span>
              <% unless review[:meets_minimum] %>
                <span class="text-yellow-600 ml-2" data-order-review-target="minimumShortfall" data-order-id="<%= order.id %>">
                  (Need <%= number_to_currency(review[:amount_to_minimum]) %> more for minimum)
                </span>
              <% end %>
            </p>
          </div>
          <div class="flex items-center gap-3">
            <% if review[:meets_minimum] %>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" data-order-review-target="minimumBadge" data-order-id="<%= order.id %>">
                Ready
              </span>
            <% else %>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800" data-order-review-target="minimumBadge" data-order-id="<%= order.id %>">
                Minimum not met
              </span>
            <% end %>
            <% can_submit = review[:meets_minimum] && !order.verifying? && order.verification_status.in?(%w[verified price_changed skipped]) %>
            <%= button_to "Submit Order",
                submit_batch_orders_path(batch_id: @batch_id, order_ids: [order.id], aggregated_list_id: @aggregated_list_id),
                method: :post,
                class: "px-4 py-1.5 rounded-md text-sm font-semibold text-white shadow-sm transition-colors #{can_submit ? 'bg-brand-orange hover:bg-brand-orange-dark cursor-pointer' : 'bg-gray-300 cursor-not-allowed'}",
                disabled: !can_submit,
                data: { order_review_target: "supplierSubmitBtn", order_id: order.id.to_s } %>
          </div>
        </div>

        <%# Delivery date & notes %>
        <% needs_delivery_date = order.delivery_date.blank? %>
        <div class="px-4 py-3 border-b flex flex-col sm:flex-row gap-3 <%= needs_delivery_date ? 'bg-amber-50 border-amber-200' : 'bg-gray-50' %>">
          <div class="flex-1">
            <label class="block text-xs font-medium <%= needs_delivery_date ? 'text-amber-700' : 'text-gray-500' %> mb-1">
              Delivery Date
              <% if needs_delivery_date %>
                <span class="text-red-500">*</span>
              <% end %>
            </label>
            <% if needs_delivery_date %>
              <p class="text-xs text-amber-600 mb-1">Select a delivery date to enable submission</p>
            <% end %>
            <input type="date"
                   value="<%= order.delivery_date %>"
                   min="<%= Date.tomorrow %>"
                   max="<%= Date.today + 30.days %>"
                   class="w-full sm:w-48 rounded-md shadow-sm focus:border-brand-green focus:ring-brand-green text-sm <%= needs_delivery_date ? 'border-amber-400 ring-1 ring-amber-300' : 'border-gray-300' %>"
                   data-action="change->order-review#updateDeliveryDate"
                   data-order-review-target="deliveryDate"
                   data-order-id="<%= order.id %>"
                   >
          </div>
          <div class="flex-1">
            <label class="block text-xs font-medium text-gray-500 mb-1">Notes</label>
            <input type="text"
                   value="<%= order.notes %>"
                   placeholder="Order notes..."
                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-brand-green focus:ring-brand-green text-sm"
                   data-action="change->order-review#updateNotes"
                   data-order-id="<%= order.id %>"
                   >
          </div>
        </div>

        <%# Price change details (per-order, hidden by default, shown by JS) %>
        <div class="hidden px-4 py-3 bg-amber-50 border-b" data-order-review-target="priceChangeDetails" data-order-id="<%= order.id %>">
          <div class="flex items-center justify-between mb-2">
            <p class="text-sm font-medium text-amber-800">Price changes detected:</p>
            <div class="flex gap-2">
              <button type="button"
                      data-action="order-review#acceptOrderPriceChanges"
                      data-order-id="<%= order.id %>"
                      class="px-2.5 py-1 text-xs font-semibold text-white bg-brand-orange rounded hover:bg-brand-orange-dark transition-colors">
                Accept
              </button>
            </div>
          </div>
          <div class="space-y-1" data-order-review-target="priceChangeList" data-order-id="<%= order.id %>">
            <%# Populated by JavaScript %>
          </div>
        </div>

        <%# Verification error (per-order, hidden by default) %>
        <div class="hidden px-4 py-3 bg-red-50 border-b" data-order-review-target="verificationErrorDetails" data-order-id="<%= order.id %>">
          <div class="flex items-center justify-between">
            <p class="text-sm text-red-700" data-order-review-target="verificationErrorText" data-order-id="<%= order.id %>"></p>
            <div class="flex gap-2">
              <button type="button"
                      data-action="order-review#retryOrderVerification"
                      data-order-id="<%= order.id %>"
                      class="px-2.5 py-1 text-xs font-semibold text-white bg-blue-600 rounded hover:bg-blue-700 transition-colors">
                Retry
              </button>
              <button type="button"
                      data-action="order-review#skipOrderVerification"
                      data-order-id="<%= order.id %>"
                      class="px-2.5 py-1 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                Skip
              </button>
            </div>
          </div>
        </div>

        <%# Desktop items table %>
        <div class="hidden sm:block">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">SKU</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Qty</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Unit Price</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase w-10"></th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% review[:items].each do |item| %>
                <tr data-order-review-target="itemRow"
                    data-item-id="<%= item.id %>"
                    data-order-id="<%= order.id %>"
                    data-unit-price="<%= item.unit_price %>"
                    data-sku="<%= item.supplier_sku %>">
                  <td class="px-4 py-2 text-sm text-gray-900"><%= item.supplier_product.supplier_name %></td>
                  <td class="px-4 py-2 text-sm text-gray-500"><%= item.supplier_sku %></td>
                  <td class="px-4 py-2 text-center">
                    <div class="inline-flex items-center gap-1">
                      <button type="button"
                              data-action="order-review#decrementItem"
                              data-item-id="<%= item.id %>"
                              data-order-id="<%= order.id %>"
                              class="w-7 h-7 flex items-center justify-center rounded-md border border-gray-300 text-gray-600 hover:bg-gray-200 hover:border-gray-400 hover:text-gray-900 active:bg-gray-300 transition-colors text-sm">
                        &minus;
                      </button>
                      <input type="number"
                             value="<%= item.quantity.to_i %>"
                             min="1"
                             class="w-14 rounded-md border-gray-300 text-sm text-center [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                             data-order-review-target="quantityInput"
                             data-action="change->order-review#updateQuantity"
                             data-item-id="<%= item.id %>"
                             data-order-id="<%= order.id %>">
                      <button type="button"
                              data-action="order-review#incrementItem"
                              data-item-id="<%= item.id %>"
                              data-order-id="<%= order.id %>"
                              class="w-7 h-7 flex items-center justify-center rounded-md border border-gray-300 text-gray-600 hover:bg-gray-200 hover:border-gray-400 hover:text-gray-900 active:bg-gray-300 transition-colors text-sm">
                        +
                      </button>
                    </div>
                  </td>
                  <td class="px-4 py-2 text-sm text-right">
                    <span class="text-gray-900" data-order-review-target="unitPriceDisplay" data-item-id="<%= item.id %>"><%= number_to_currency(item.unit_price) %></span>
                    <span class="hidden block text-xs mt-0.5" data-order-review-target="priceDiff" data-item-id="<%= item.id %>"></span>
                  </td>
                  <td class="px-4 py-2 text-sm font-medium text-gray-900 text-right" data-order-review-target="lineTotal" data-item-id="<%= item.id %>">
                    <%= number_to_currency(item.line_total) %>
                  </td>
                  <td class="px-4 py-2 text-center">
                    <button type="button"
                            data-action="order-review#removeItem"
                            data-item-id="<%= item.id %>"
                            data-order-id="<%= order.id %>"
                            class="text-red-400 hover:text-red-600 transition-colors"
                            title="Remove item">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                      </svg>
                    </button>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <%# Mobile cards %>
        <div class="sm:hidden divide-y divide-gray-200">
          <% review[:items].each do |item| %>
            <div class="p-3"
                 data-order-review-target="itemRow"
                 data-item-id="<%= item.id %>"
                 data-order-id="<%= order.id %>"
                 data-unit-price="<%= item.unit_price %>"
                 data-sku="<%= item.supplier_sku %>">
              <div class="flex justify-between items-start mb-2">
                <div class="flex-1 min-w-0 mr-3">
                  <p class="text-sm font-medium text-gray-900"><%= item.supplier_product.supplier_name %></p>
                  <p class="text-xs text-gray-400">SKU: <%= item.supplier_sku %></p>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-sm font-semibold text-gray-900" data-order-review-target="lineTotal" data-item-id="<%= item.id %>">
                    <%= number_to_currency(item.line_total) %>
                  </span>
                  <button type="button"
                          data-action="order-review#removeItem"
                          data-item-id="<%= item.id %>"
                          data-order-id="<%= order.id %>"
                          class="text-red-400 hover:text-red-600 transition-colors"
                          title="Remove item">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <div>
                  <span class="text-xs text-gray-500" data-order-review-target="unitPriceDisplay" data-item-id="<%= item.id %>"><%= number_to_currency(item.unit_price) %> each</span>
                  <span class="hidden text-xs" data-order-review-target="priceDiff" data-item-id="<%= item.id %>"></span>
                </div>
                <div class="inline-flex items-center gap-1">
                  <button type="button"
                          data-action="order-review#decrementItem"
                          data-item-id="<%= item.id %>"
                          data-order-id="<%= order.id %>"
                          class="w-8 h-8 flex items-center justify-center rounded-md border border-gray-300 text-gray-600 hover:bg-gray-200 hover:border-gray-400 hover:text-gray-900 active:bg-gray-300 transition-colors">
                    &minus;
                  </button>
                  <input type="number"
                         value="<%= item.quantity.to_i %>"
                         min="1"
                         class="w-14 rounded-md border-gray-300 text-sm text-center [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                         data-order-review-target="quantityInput"
                         data-action="change->order-review#updateQuantity"
                         data-item-id="<%= item.id %>"
                         data-order-id="<%= order.id %>">
                  <button type="button"
                          data-action="order-review#incrementItem"
                          data-item-id="<%= item.id %>"
                          data-order-id="<%= order.id %>"
                          class="w-8 h-8 flex items-center justify-center rounded-md border border-gray-300 text-gray-600 hover:bg-gray-200 hover:border-gray-400 hover:text-gray-900 active:bg-gray-300 transition-colors">
                    +
                  </button>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <%# Quick-add suggestions (only when minimum not met) %>
        <% if !review[:meets_minimum] && review[:suggestions].present? %>
          <div class="px-4 py-3 bg-yellow-50 border-t border-yellow-200"
               data-order-review-target="suggestionsSection"
               data-order-id="<%= order.id %>">
            <p class="text-xs font-medium text-yellow-700 mb-2">Quick add to reach minimum:</p>
            <div class="flex flex-wrap gap-2">
              <% review[:suggestions].each do |sp| %>
                <button type="button"
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-white border border-yellow-300 text-sm leading-tight text-gray-800 hover:bg-yellow-100 hover:border-yellow-400 transition-colors shadow-sm max-w-xs"
                        data-action="order-review#addSuggestion"
                        data-order-id="<%= order.id %>"
                        data-supplier-product-id="<%= sp.id %>"
                        data-product-name="<%= sp.supplier_name %>"
                        data-product-sku="<%= sp.supplier_sku %>"
                        data-product-price="<%= sp.current_price %>"
                        data-product-pack-size="<%= sp.pack_size %>">
                  <svg class="w-4 h-4 min-w-[16px] text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                  </svg>
                  <span class="truncate max-w-[180px]"><%= sp.supplier_name %></span>
                  <span class="text-gray-500 text-xs whitespace-nowrap">
                    <%= number_to_currency(sp.current_price) %><% if sp.pack_size.present? %> / <%= sp.pack_size %><% end %>
                  </span>
                </button>
              <% end %>
            </div>
          </div>
        <% end %>

        <%# Order footer with subtotal %>
        <div class="px-4 py-3 bg-gray-50 border-t flex justify-between items-center">
          <span class="text-sm font-medium text-gray-700">
            Subtotal: <span data-order-review-target="orderSubtotalFooter" data-order-id="<%= order.id %>"><%= number_to_currency(review[:subtotal]) %></span>
          </span>
        </div>
      </div>
    <% end %>
  </div>

  <%# Bottom action bar %>
  <div class="bg-white shadow rounded-lg p-4 sm:p-6">
    <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
      <%= link_to "Back to Order Lists", supplier_lists_path,
          class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-center" %>

      <% all_verified = !@verifying && @review_orders.all? { |r| r[:verification_status].in?(%w[verified price_changed skipped]) } %>
      <% can_submit_all = @summary[:all_minimums_met] && all_verified %>
      <%= button_to "Submit All Orders",
          submit_batch_orders_path(batch_id: @batch_id, aggregated_list_id: @aggregated_list_id),
          method: :post,
          class: "px-6 py-2 text-sm font-semibold text-white rounded-md shadow-sm transition-colors text-center #{can_submit_all ? 'bg-brand-orange hover:bg-brand-orange-dark cursor-pointer' : 'bg-gray-300 cursor-not-allowed'}",
          disabled: !can_submit_all,
          data: { order_review_target: "submitAllBtn" } %>
    </div>
  </div>
</div>
