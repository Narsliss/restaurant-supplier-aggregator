<div class="max-w-4xl mx-auto">
  <div class="flex flex-col gap-3 sm:flex-row sm:justify-between sm:items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Order History</h1>
  </div>

  <!-- Date Range Filter -->
  <div class="bg-white shadow rounded-lg p-4 mb-6">
    <%= form_with(url: orders_path, method: :get, class: "flex flex-col gap-3 sm:flex-row sm:flex-wrap sm:items-end") do |form| %>
      <div class="flex-1 min-w-[200px]">
        <%= form.label :search, "Search", class: "block text-xs font-medium text-gray-500 mb-1" %>
        <%= form.text_field :search, value: params[:search], placeholder: "Order ID or confirmation #...", class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-green focus:ring-brand-green text-sm" %>
      </div>
      <div class="sm:w-40">
        <%= form.label :supplier_id, "Supplier", class: "block text-xs font-medium text-gray-500 mb-1" %>
        <%= form.select :supplier_id,
            [["All Suppliers", ""]] + @suppliers.map { |s| [s.name, s.id] },
            { selected: params[:supplier_id] || "" },
            class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-green focus:ring-brand-green text-sm" %>
      </div>
      <div class="sm:w-32">
        <%= form.label :date_from, "From", class: "block text-xs font-medium text-gray-500 mb-1" %>
        <%= form.date_field :date_from, value: @date_from, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-green focus:ring-brand-green text-sm" %>
      </div>
      <div class="sm:w-32">
        <%= form.label :date_to, "To", class: "block text-xs font-medium text-gray-500 mb-1" %>
        <%= form.date_field :date_to, value: @date_to, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-green focus:ring-brand-green text-sm" %>
      </div>
      <div class="flex gap-2">
        <%= form.submit "Filter", class: "bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 text-sm cursor-pointer" %>
        <% if params[:search].present? || params[:supplier_id].present? || params[:date_from].present? || params[:date_to].present? %>
          <%= link_to "Clear", orders_path, class: "text-sm text-gray-500 hover:text-gray-700 px-2 py-2" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- KPI Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
    <div class="bg-white shadow rounded-lg p-4">
      <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Orders Placed</p>
      <p class="mt-1 text-2xl font-bold text-gray-900"><%= @order_count %></p>
    </div>
    <div class="bg-white shadow rounded-lg p-4">
      <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Total Spent</p>
      <p class="mt-1 text-2xl font-bold text-gray-900"><%= number_to_currency(@total_spent) %></p>
    </div>
    <div class="bg-white shadow rounded-lg p-4 border-l-4 border-brand-green">
      <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Total Savings</p>
      <p class="mt-1 text-2xl font-bold text-green-600"><%= number_to_currency(@total_savings) %></p>
      <% if @total_spent > 0 && @total_savings > 0 %>
        <p class="text-xs text-green-500 mt-0.5">
          <%= number_to_percentage((@total_savings / @total_spent) * 100, precision: 1) %> saved vs. highest prices
        </p>
      <% end %>
    </div>
  </div>

  <% if @order_groups.any? %>
    <p class="text-sm text-gray-500 mb-3">
      <%= @order_count %> orders in <%= @order_groups.size %> <%= @order_groups.size == 1 ? "group" : "groups" %>
    </p>

    <div class="space-y-4">
      <% @order_groups.each do |orders| %>
        <% is_split = orders.size > 1 %>
        <% group_total = orders.sum { |o| o.total_amount || 0 } %>
        <% group_savings = orders.sum { |o| o.savings_amount || 0 } %>
        <% group_items = orders.sum { |o| o.order_items.size } %>
        <% group_date = orders.map(&:submitted_at).compact.max %>
        <% order_list = orders.first.order_list %>

        <div class="bg-white shadow rounded-lg overflow-hidden">
          <% if is_split %>
            <%# === Split Order Group Header === %>
            <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
              <div class="flex items-start justify-between gap-2">
                <div class="min-w-0 flex-1">
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-brand-green-50 text-brand-green-dark">
                      Split Order
                    </span>
                    <% if order_list %>
                      <span class="text-sm text-gray-500"><%= order_list.name %></span>
                    <% end %>
                  </div>
                  <p class="text-sm text-gray-500 mt-1">
                    <%= group_items %> items across <%= orders.size %> suppliers &middot; <%= number_to_currency(group_total) %>
                    <% if group_date %>
                      <span class="hidden sm:inline">&middot; <%= group_date.strftime("%b %d, %Y") %></span>
                    <% end %>
                  </p>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <% if group_savings > 0 %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                      Saved <%= number_to_currency(group_savings) %>
                    </span>
                  <% end %>
                </div>
              </div>
            </div>

            <%# === Per-Supplier Sub-Rows === %>
            <div class="divide-y divide-gray-100">
              <% orders.each do |order| %>
                <div class="px-4 py-3 hover:bg-gray-50">
                  <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0 flex-1 pl-4">
                      <h3 class="text-sm font-medium text-gray-900">
                        <%= link_to order.supplier.name, order_path(order), class: "hover:text-brand-orange" %>
                      </h3>
                      <p class="text-sm text-gray-500 mt-0.5">
                        <%= order.order_items.size %> items &middot; <%= number_to_currency(order.total_amount) %>
                      </p>
                      <% if order.confirmation_number.present? %>
                        <p class="text-xs text-gray-400 break-all">Confirmation: <%= order.confirmation_number %></p>
                      <% end %>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                      <% if order.savings_amount.to_f > 0 %>
                        <span class="text-xs text-green-600">
                          <%= number_to_currency(order.savings_amount) %>
                        </span>
                      <% end %>
                      <% if order.confirmed? %>
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Confirmed</span>
                      <% elsif order.submitted? %>
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Completed</span>
                      <% end %>
                      <%= link_to "View", order_path(order), class: "hidden sm:inline text-sm text-brand-orange hover:text-brand-orange-dark font-medium" %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>

          <% else %>
            <%# === Single Supplier Order === %>
            <% order = orders.first %>
            <div class="p-4">
              <div class="flex items-start justify-between gap-2">
                <div class="min-w-0 flex-1">
                  <h3 class="text-sm font-medium text-gray-900">
                    <%= link_to "Order ##{order.id}", order_path(order), class: "hover:text-brand-orange" %>
                    <span class="hidden sm:inline">&middot;</span>
                    <span class="block sm:inline text-gray-500 sm:text-gray-900"><%= order.supplier.name %></span>
                  </h3>
                  <p class="text-sm text-gray-500 mt-0.5">
                    <%= order.order_items.size %> items &middot; <%= number_to_currency(order.total_amount) %>
                    <% if order.submitted_at %>
                      <span class="hidden sm:inline">&middot; <%= order.submitted_at.strftime("%b %d, %Y") %></span>
                    <% end %>
                  </p>
                  <% if order.confirmation_number.present? %>
                    <p class="text-xs text-gray-400 break-all">Confirmation: <%= order.confirmation_number %></p>
                  <% end %>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <% if order.savings_amount.to_f > 0 %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                      Saved <%= number_to_currency(order.savings_amount) %>
                    </span>
                  <% end %>
                  <% if order.confirmed? %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Confirmed</span>
                  <% elsif order.submitted? %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Completed</span>
                  <% end %>
                  <%= link_to "View", order_path(order), class: "hidden sm:inline text-sm text-brand-orange hover:text-brand-orange-dark font-medium" %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="text-center py-12 bg-white rounded-lg shadow">
      <p class="text-gray-500">No orders found for this period.</p>
      <% if params[:search].present? || params[:supplier_id].present? %>
        <p class="mt-2">
          <%= link_to "Clear filters", orders_path, class: "text-brand-orange hover:text-brand-orange-dark" %>
        </p>
      <% end %>
    </div>
  <% end %>
</div>
