<div class="max-w-4xl mx-auto">
  <h1 class="text-2xl font-bold text-gray-900 mb-2">Split Order Preview</h1>
  <p class="text-sm text-gray-500 mb-6">
    Order List: <strong><%= @order_list.name %></strong> &middot;
    Items will be ordered from the supplier with the best price.
  </p>

  <% if @preview[:warnings].any? %>
    <div class="mb-6 space-y-2">
      <% @preview[:warnings].each do |warning| %>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <p class="text-yellow-800 text-sm">
            <span class="font-medium">Warning:</span> <%= warning[:message] %>
            <% if warning[:type] == "minimum_not_met" %>
              <br><span class="text-yellow-600">Current: <%= number_to_currency(warning[:current_total]) %>, Need: <%= number_to_currency(warning[:shortfall]) %> more</span>
            <% end %>
          </p>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Summary -->
  <div class="bg-white shadow rounded-lg p-4 mb-6">
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
      <div>
        <p class="text-2xl font-bold text-gray-900"><%= @preview[:summary][:supplier_count] %></p>
        <p class="text-xs text-gray-500">Suppliers</p>
      </div>
      <div>
        <p class="text-2xl font-bold text-gray-900"><%= @preview[:summary][:total_items] %></p>
        <p class="text-xs text-gray-500">Items</p>
      </div>
      <div>
        <p class="text-2xl font-bold text-green-600"><%= number_to_currency(@preview[:summary][:total_amount]) %></p>
        <p class="text-xs text-gray-500">Total (Best Prices)</p>
      </div>
      <% if @preview[:summary][:unassigned_count] > 0 %>
        <div>
          <p class="text-2xl font-bold text-red-600"><%= @preview[:summary][:unassigned_count] %></p>
          <p class="text-xs text-gray-500">Unavailable</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Orders by Supplier -->
  <div class="space-y-4 mb-6">
    <% @preview[:assignments].each do |assignment| %>
      <div class="bg-white shadow rounded-lg overflow-hidden <%= assignment[:meets_minimum] ? '' : 'ring-2 ring-yellow-400' %>">
        <div class="px-4 py-3 bg-gray-50 border-b flex justify-between items-center">
          <div>
            <h3 class="font-medium text-gray-900"><%= assignment[:supplier][:name] %></h3>
            <p class="text-sm text-gray-500">
              <%= assignment[:item_count] %> items &middot;
              <%= number_to_currency(assignment[:subtotal]) %>
              <% unless assignment[:meets_minimum] %>
                <span class="text-yellow-600 ml-2">
                  (Need <%= number_to_currency(assignment[:amount_to_minimum]) %> more for minimum)
                </span>
              <% end %>
            </p>
          </div>
          <% if assignment[:meets_minimum] %>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
              Ready
            </span>
          <% else %>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
              Minimum not met
            </span>
          <% end %>
        </div>

        <!-- Mobile card layout -->
        <div class="sm:hidden divide-y divide-gray-200">
          <% assignment[:items].each do |item| %>
            <div class="p-3">
              <p class="text-sm font-medium text-gray-900"><%= item[:product_name] %></p>
              <div class="flex justify-between text-sm text-gray-500 mt-1">
                <span>Qty: <%= item[:quantity] %> @ <%= number_to_currency(item[:unit_price]) %></span>
                <span class="font-semibold text-gray-900"><%= number_to_currency(item[:line_total]) %></span>
              </div>
              <p class="text-xs text-gray-400 mt-1">SKU: <%= item[:supplier_sku] %></p>
            </div>
          <% end %>
        </div>

        <!-- Desktop table -->
        <div class="hidden sm:block">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">SKU</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Qty</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Unit Price</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% assignment[:items].each do |item| %>
                <tr>
                  <td class="px-4 py-2 text-sm text-gray-900"><%= item[:product_name] %></td>
                  <td class="px-4 py-2 text-sm text-gray-500"><%= item[:supplier_sku] %></td>
                  <td class="px-4 py-2 text-sm text-gray-900 text-center"><%= item[:quantity] %></td>
                  <td class="px-4 py-2 text-sm text-gray-900 text-right"><%= number_to_currency(item[:unit_price]) %></td>
                  <td class="px-4 py-2 text-sm text-gray-900 text-right"><%= number_to_currency(item[:line_total]) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Actions -->
  <% all_minimums_met = @preview[:assignments].all? { |a| a[:meets_minimum] } %>

  <%= form_with(url: split_create_orders_path, method: :post, class: "bg-white shadow rounded-lg p-4 sm:p-6") do |form| %>
    <%= form.hidden_field :order_list_id, value: @order_list.id %>

    <div class="mb-4">
      <%= form.label :delivery_date, "Delivery Date", class: "block text-sm font-medium text-gray-700" %>
      <div class="mt-1">
        <%= form.date_field :delivery_date,
            value: Date.tomorrow,
            min: Date.today,
            max: Date.today + 30.days,
            class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-green focus:ring-brand-green" %>
      </div>
      <p class="mt-1 text-xs text-gray-500">All orders will use this delivery date.</p>
    </div>

    <div class="mb-4">
      <label class="flex items-center">
        <%= form.check_box :submit_immediately, class: "rounded border-gray-300 text-brand-orange focus:ring-brand-orange" %>
        <span class="ml-2 text-sm text-gray-700">Submit orders immediately after creation</span>
      </label>
      <p class="ml-6 text-xs text-gray-500">If unchecked, orders will be created in "pending" status for review.</p>
    </div>

    <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
      <%= link_to "Cancel", price_comparison_order_list_path(@order_list), class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-center" %>

      <% if all_minimums_met %>
        <%= form.submit "Create #{@preview[:assignments].size} Orders", class: "px-4 py-2 text-sm font-medium text-white bg-brand-orange rounded-md hover:bg-brand-orange-dark cursor-pointer" %>
      <% else %>
        <span class="px-4 py-2 text-sm font-medium text-white bg-gray-400 rounded-md cursor-not-allowed text-center" title="Some suppliers don't meet order minimums">
          Create Orders (Minimums Not Met)
        </span>
      <% end %>
    </div>
  <% end %>
</div>
