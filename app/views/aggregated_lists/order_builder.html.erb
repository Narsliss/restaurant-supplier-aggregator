<div class="max-w-6xl mx-auto pb-48" data-controller="order-builder">
  <div class="mb-6">
    <%= link_to "&larr; Order Lists".html_safe, supplier_lists_path, class: "text-sm text-brand-orange hover:text-brand-orange-light" %>
  </div>

  <div class="flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-start mb-6">
    <div>
      <h1 class="text-2xl font-heading font-bold text-gray-900">Build Order</h1>
      <p class="mt-1 text-sm text-gray-500">
        <%= @aggregated_list.name %> &middot; <%= @suppliers.map(&:name).join(" vs ") %>
      </p>
    </div>
    <%= link_to "View Matches", aggregated_list_path(@aggregated_list),
        class: "inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors" %>
  </div>

  <%= form_with(url: create_from_aggregated_list_orders_path, method: :post, id: "order-form") do |form| %>
    <%= hidden_field_tag :aggregated_list_id, @aggregated_list.id %>

    <%# Fixed command bar â€” KPIs + delivery date + submit (JS moves to body for true fixed positioning) %>
    <div id="order-builder-command-bar" class="bg-gray-50 pt-1 pb-3">
      <div class="grid grid-cols-3 gap-4 mb-3">
        <div class="bg-white shadow rounded-lg p-4">
          <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Items Selected</p>
          <p class="mt-1 text-2xl font-bold text-gray-900" data-order-builder-target="itemCount">0</p>
        </div>
        <div class="bg-white shadow rounded-lg p-4">
          <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Estimated Total</p>
          <p class="mt-1 text-2xl font-bold text-gray-900" data-order-builder-target="runningTotal">$0.00</p>
        </div>
        <div class="bg-white shadow rounded-lg p-4">
          <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Suppliers</p>
          <p class="mt-1 text-2xl font-bold text-gray-900" data-order-builder-target="supplierCount">0</p>
        </div>
      </div>
      <div class="bg-white shadow rounded-lg p-3">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-4">
            <div class="hidden sm:block">
              <%= date_field_tag :delivery_date, nil, class: "w-40 rounded-md border-gray-300 shadow-sm focus:border-brand-green focus:ring-brand-green text-sm" %>
            </div>
            <div class="text-sm text-gray-500">
              <span id="action-bar-item-count">0</span> items &middot;
              <span class="font-semibold text-gray-900" id="action-bar-running-total">$0.00</span>
            </div>
          </div>
          <div class="flex gap-3">
            <%= link_to "Cancel", supplier_lists_path, class: "px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900" %>
            <button type="submit"
                    disabled
                    data-order-builder-target="submitButton"
                    class="px-6 py-2 rounded-md text-sm font-semibold text-white shadow-sm transition-colors bg-gray-300 cursor-not-allowed">
              Create Pending Orders
            </button>
          </div>
        </div>
      </div>
    </div>

    <% if @product_matches.any? %>
      <%# Desktop table %>
      <div class="hidden sm:block">
        <table class="min-w-full divide-y divide-gray-200" id="order-builder-table">
          <thead id="order-builder-thead">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-brand-navy">Product</th>
              <% @suppliers.each do |supplier| %>
                <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-brand-navy"><%= supplier.name %></th>
              <% end %>
              <th class="px-4 py-3 text-center text-xs font-medium text-white uppercase tracking-wider bg-brand-navy">Qty</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-white uppercase tracking-wider bg-brand-navy">Line Total</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 bg-white">
            <% @product_matches.each_with_index do |match, idx| %>
              <% cheapest = match.cheapest_supplier %>
              <% most_expensive = match.most_expensive_supplier %>
              <% cheapest_price = cheapest&.dig(:price) || 0 %>
              <% cheapest_supplier_id = cheapest&.dig(:supplier)&.id %>

              <tr data-order-builder-row class="hover:bg-gray-50">
                <%# Product name %>
                <td class="px-4 py-3">
                  <div class="text-sm font-medium text-gray-900"><%= match.display_name %></div>
                </td>

                <%# Per-supplier prices %>
                <% @suppliers.each do |supplier| %>
                  <td class="px-4 py-3">
                    <% item = match.item_for_supplier(supplier) %>
                    <% if item %>
                      <% is_cheapest = cheapest && cheapest[:supplier] == supplier && match.price_spread && match.price_spread > 0 %>
                      <% is_most_expensive = most_expensive && most_expensive[:supplier] == supplier && match.price_spread && match.price_spread > 0 %>
                      <span class="text-sm font-semibold <%= is_cheapest ? 'text-green-700' : is_most_expensive ? 'text-red-600' : 'text-gray-900' %>">
                        <%= item.formatted_price %>
                      </span>
                      <% if item.pack_size.present? %>
                        <span class="block text-xs text-gray-500"><%= item.pack_size %></span>
                      <% end %>
                      <% unless item.in_stock %>
                        <span class="block text-xs text-red-500">Out of stock</span>
                      <% end %>
                    <% else %>
                      <span class="text-sm text-gray-300">&mdash;</span>
                    <% end %>
                  </td>
                <% end %>

                <%# Quantity input with +/- buttons %>
                <td class="px-4 py-3 text-center">
                  <div class="inline-flex items-center gap-1">
                    <button type="button"
                            data-action="order-builder#decrement"
                            class="w-7 h-7 flex items-center justify-center rounded-md border border-gray-300 text-gray-500 hover:bg-gray-100 text-sm">
                      &minus;
                    </button>
                    <input type="number"
                           name="quantities[<%= match.id %>]"
                           value="0"
                           min="0"
                           class="w-14 rounded-md border-gray-300 text-sm text-center [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                           data-order-builder-target="quantityInput"
                           data-action="input->order-builder#updateTotals"
                           data-price="<%= cheapest_price %>"
                           data-supplier-id="<%= cheapest_supplier_id %>">
                    <button type="button"
                            data-action="order-builder#increment"
                            class="w-7 h-7 flex items-center justify-center rounded-md border border-gray-300 text-gray-500 hover:bg-gray-100 text-sm">
                      +
                    </button>
                  </div>
                </td>

                <%# Line total %>
                <td class="px-4 py-3 text-right">
                  <span class="text-sm font-medium text-gray-900" data-order-builder-target="lineTotal">&mdash;</span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <%# Mobile cards %>
      <div class="sm:hidden space-y-3">
        <% @product_matches.each_with_index do |match, idx| %>
          <% cheapest = match.cheapest_supplier %>
          <% most_expensive = match.most_expensive_supplier %>
          <% cheapest_price = cheapest&.dig(:price) || 0 %>
          <% cheapest_supplier_id = cheapest&.dig(:supplier)&.id %>

          <div class="bg-white shadow rounded-lg p-4" data-order-builder-row>
            <div class="flex justify-between items-start mb-2">
              <div class="flex-1 min-w-0 mr-3">
                <h3 class="text-sm font-medium text-gray-900"><%= match.display_name %></h3>
              </div>
              <span class="text-sm font-medium text-gray-900" data-order-builder-target="lineTotal">&mdash;</span>
            </div>

            <%# Supplier prices %>
            <div class="flex flex-wrap gap-2 mb-3">
              <% @suppliers.each do |supplier| %>
                <% item = match.item_for_supplier(supplier) %>
                <% if item %>
                  <% is_cheapest = cheapest && cheapest[:supplier] == supplier && match.price_spread && match.price_spread > 0 %>
                  <div class="text-xs">
                    <span class="text-gray-500"><%= supplier.name %>:</span>
                    <span class="font-semibold <%= is_cheapest ? 'text-green-700' : 'text-gray-900' %>"><%= item.formatted_price %></span>
                    <% unless item.in_stock %>
                      <span class="text-red-500">(OOS)</span>
                    <% end %>
                  </div>
                <% end %>
              <% end %>
            </div>

            <%# Quantity controls %>
            <div class="flex items-center justify-center gap-2">
              <button type="button"
                      data-action="order-builder#decrement"
                      class="w-8 h-8 flex items-center justify-center rounded-md border border-gray-300 text-gray-500 hover:bg-gray-100">
                &minus;
              </button>
              <input type="number"
                     name="quantities[<%= match.id %>]"
                     value="0"
                     min="0"
                     class="w-16 rounded-md border-gray-300 text-sm text-center [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                     data-order-builder-target="quantityInput"
                     data-action="input->order-builder#updateTotals"
                     data-price="<%= cheapest_price %>"
                     data-supplier-id="<%= cheapest_supplier_id %>">
              <button type="button"
                      data-action="order-builder#increment"
                      class="w-8 h-8 flex items-center justify-center rounded-md border border-gray-300 text-gray-500 hover:bg-gray-100">
                +
              </button>
            </div>
          </div>
        <% end %>
      </div>

    <% else %>
      <div class="bg-white shadow rounded-lg p-8 text-center">
        <p class="text-gray-500">No matched products found. Go back and review product matching first.</p>
        <p class="mt-3">
          <%= link_to "View Matches", aggregated_list_path(@aggregated_list), class: "text-brand-orange hover:text-brand-orange-dark font-medium" %>
        </p>
      </div>
    <% end %>
  <% end %>
</div>
